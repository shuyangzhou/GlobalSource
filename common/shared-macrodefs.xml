<?xml version="1.0" encoding="UTF-8"?>

<project name="macro-definitions" default="default" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
	<property file="build-ext.properties" />
	<property file="build.properties" />

	<property name="project.dir" value="portal" />
	<property name="sdk.dir" value="${portal.dir}/tools/sdk" />

	<property name="module.list" value="" />
	<property name="path.list" value="" />
	<property name="test.list" value="" />

	<property environment="env" />

	<path id="project.lib.path">
		<fileset dir="../common/lib" includes="*.jar" />
	</path>

	<taskdef classpath="${portal.dir}/lib/development/ant-contrib.jar" resource="net/sf/antcontrib/antlib.xml" />
	<taskdef classpathref="project.lib.path" resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" />

	<macrodef name="append-list">
		<attribute name="list" />
		<attribute name="src.dir.name" />

		<sequential>
			<if>
				<equals arg1="${@{list}}" arg2="" />
				<then>
					<var name="@{list}" value="@{src.dir.name}" />
				</then>
				<else>
					<var name="@{list}" value="${@{list}},@{src.dir.name}" />
				</else>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="gradle-execute">
		<attribute default="${basedir}" name="dir" />
		<attribute default="true" name="failonerror" />
		<attribute default="true" name="forcedcacheenabled" />
		<attribute name="task" />
		<element implicit="true" name="args" optional="true" />

		<sequential>
			<if>
				<os family="unix" />
				<then>
					<property name="gradlew.suffix" value="" />

					<chmod file="${portal.dir}/gradlew${gradlew.suffix}" perm="a+x" />
				</then>
				<else>
					<property name="gradlew.suffix" value=".bat" />
				</else>
			</if>

			<exec dir="@{dir}" executable="${portal.dir}/gradlew${gradlew.suffix}" failonerror="@{failonerror}">
				<args />
				<arg value="@{task}" />
			</exec>
		</sequential>
	</macrodef>

	<macrodef name="set-module-source-directory">
		<attribute name="module" />

		<sequential>
			<dirname property="src.dir" file="@{module}" />

			<basename property="src.dir.name" file="${src.dir}" />

			<if>
				<equals arg1="${src.dir.name}" arg2="WEB-INF" />
				<then>
					<dirname property="temp" file="${src.dir}" />

					<var name="src.dir" unset="true" />

					<dirname property="src.dir" file="${temp}" />

					<var name="temp" unset="true" />
					<var name="src.dir.name" unset="true" />

					<basename property="src.dir.name" file="${src.dir}" />
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="common-build">
		<element name="build.diff" />

		<sequential>
			<mkdir dir="classes" />

			<javac
				destdir="classes"
				classpathref="project.lib.path"
				includeantruntime="false">

				<src path="../common/src" />
				<src path="src" />
			</javac>

			<unzip src="${project.dir}/CleanProject.zip" dest="${project.dir}/" />

			<copy file="${project.dir}/nbproject/default.properties" tofile="${project.dir}/nbproject/project.properties" />

			<concat destfile="${project.dir}/nbproject/project.properties" append="true">excludes=${exclude.types}
	</concat>

			<concat destfile="${project.dir}/nbproject/project.properties" append="true">file.reference.portal-web.src=${portal.dir}/portal-web/docroot
	src.portal-web.dir=$${file.reference.portal-web.src}

	</concat>

			<for param="module">
				<path>
					<dirset dir="${portal.dir}">
						<include name="**/src"/>
					</dirset>
				</path>
				<sequential>
					<local name="src.dir" />
					<local name="src.dir.name" />

					<set-module-source-directory module="@{module}" />

					<if>
						<and>
							<not>
								<contains string="${exclude.modules}" substring="${src.dir.name}" />
							</not>
							<available file="${src.dir}/build.xml" />
						</and>
						<then>
							<build.diff />

							<java classname="com.liferay.netbeansproject.GradleResolver" classpath="classes" classpathref="project.lib.path">
								<arg value="${src.dir}" />
								<arg value="portal/modules/${src.dir.name}" />
							</java>
						</then>
					</if>
				</sequential>
			</for>
			<java classname="com.liferay.netbeansproject.GradleSettingCreator" classpath="classes" classpathref="project.lib.path">
				<arg value="${module.list}" />
			</java>
			<gradle-execute task="copyDependencies">
				<arg value="-PbuildDir=lib" />
			</gradle-execute>
		</sequential>
	</macrodef>

	<macrodef name="clean">
		<sequential>
			<delete file="settings.gradle" />
			<delete dir="classes" />
			<delete dir="${project.dir}/modules" />
			<delete dir="${project.dir}/nbproject" />
		</sequential>
	</macrodef>
</project>